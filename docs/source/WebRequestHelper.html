<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var Base = require('../../web/Processor');

<span id='NGNX-web-WebRequestHelper'>/**
</span> * @class NGNX.web.WebRequestHelper
 * A request processor that creates several additional attributes on a request object. This is designed for making
 * it easier to write routes.
 * 
 * Provides the following additions to the request scope:
 * 
 * * **form**: An form or pre-parsed JSON body found in a `POST`, `PUT`, or `DELETE` request.
 * * **qs**: Query string parameters passed in the URL.
 * * **route**: Any route variables available via route regex.
 * * **cgi**: On object containing `path_info`, `user_agent`, `method`, &amp; `http_accept`.
 * * **browser**: On object containing `name`, `version`, `family`, `major`, `minor`, `patch`, &amp; `mobile`.
 * 
 * _Example route.js_
 * 
 * `POST http://localhost/:userid/token?resend=true`
 * 
 * `{&quot;address&quot;:&quot;jdoe@doe.com&quot;}`
 * 
 * 		'/:user': {
 * 			post: function(req,res){
 * 				var usr = getUser(req.route.userid);
 * 				if (usr.email !== req.form.address)
 * 					throw Error();
 * 				else if (req.url.resend !== undefined){
 * 					if (req.url.resend)
 * 						usr.resendEmail();
 * 				}
 * 			}
 * 		}
 * 
 * This should be implemented as a NGN.web.Server#processor.
 * 
 * **Example**
 * 		var web = new NGN.web.Server({
 * 			port: 8181,
 * 			processor: new NGNX.web.WebRequestHelper()
 * 		});
 * @singleton
 * @extends NGN.web.Processor
 */

var Class = Base.extend({
	
<span id='NGNX-web-WebRequestHelper-method-constructor'>	/**
</span>	 * @constructor
	 * Create a new RequestAid middleware method.
	 * @returns {Function}
	 */
	constructor: function(){
		
		Class.super.constructor.call(this,{
			fn: function(req,res,next){
				var ua = (req.headers['user-agent'] || '').toLowerCase();
				var uaParser = require('ua-parser');
				var b = uaParser.parse(ua);		
				
				req.form = 	req.method.trim().toUpperCase() == 'PUT' 
							|| req.method.trim().toUpperCase() == 'POST'
							|| req.method.trim().toUpperCase() == 'DELETE'
							? (typeof req.body === 'string' ? JSON.parse(req.body) : req.body)
							: {};
				req.qs		= req.query || {};
				req.route	= req.params || {};
				req.cgi		= {
								path_info: req.url,
								user_agent: ua,
								method: req.originalMethod || __req.method,
								'http_accept': req.headers.accept !== undefined ? req.headers.accept.split(',') : []
							};
				req.browser	= {
								name: b.toString(),
								version: b.toVersionString(),
								family:	b.family,
								major: b.major || null,
								minor: b.minor || null,
								patch: b.patch || null,
								mobile: __NGN.pattern.isMobileDevice(ua)	
							};

				for(var el in req.route){
					if (req.form.hasOwnProperty(el))
						delete req.route[el];
					if (req.qs.hasOwnProperty(el))
						delete req.route[el];

				}

				// Specific to web server
				if (res.locals) {
					res.locals({
						url: 		req.url,
						browser: 	req.browser
					});

					if (global.application !== undefined)
						res.locals.application = global.application.toJson();

					if (req.form !== {})
						res.locals.form = req.form;
				}

				next();
			}
		});
		
	}
	
});

module.exports = Class;</pre>
</body>
</html>
