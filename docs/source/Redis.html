<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var redis       = require('redis'),
    Connection  = require('./Connection');

<span id='NGN-datasource-Redis'>/**
</span> * @class NGN.datasource.Redis
 * Represents a connection to a Redis instance.
 * @extends NGN.datasource.Connection
 * @requires Redis
 * @docauthor Corey Butler
 */
var Class = Connection.extend({
    
<span id='NGN-datasource-Redis-method-constructor'>    /**
</span>     * @constructor
     * Create a new connection to a Redis instance.
     */
    constructor: function( config ){
        
        // Default configuration
        config = config || {};
       
        // Inherit parent object
        Class.super.constructor.call( this, config );
                
        // Self reference
        var me = this;
        
        // Set default connection attributes
        this.type    = 'Redis';
        
<span id='NGN-datasource-Redis-cfg-host'>        /**
</span>         * @cfg {String} [host=127.0.0.1]
         * The host server.
         */
        this.host    = config.host   || '127.0.0.1';
        
<span id='NGN-datasource-Redis-cfg-port'>        /**
</span>         * @cfg {Number} [port=6379]
         * The host port.
         */
        this.port    = config.port     || 6379;
        

<span id='NGN-datasource-Redis-cfg-database'>    	/**
</span>    	 * @cfg {Number} [database=1]
    	 * The database index to use when creating a connection. 
    	 */
    	this.database = config.database || 1;
        
<span id='NGN-datasource-Redis-property-client'>        /**
</span>         * @property
         * @readonly
         * @protected
         * The underlying [Redis client](https://github.com/mranney/node_redis) used to interact with the Redis database instance. 
         */
        Class.super.client = this.autoConnect == true ? redis.createClient( this.port, this.host ) : {connected:false}
        
        // Create a secure connection if a password is provided.
        if (this.autoConnect)
        	this.connect();
    },
    
<span id='NGN-datasource-Redis-method-connect'>    /**
</span>     * @method
     * Connect to the Redis instance. Supports authentication if a #password is provided.
     */
    connect: function(){  	
    	var me = this;

		this.onConnect();

		if (this.client.hasOwnProperty('placeholder')) {
			this.client = redis.createClient(this.port,this.host);
		}
		
		this.client.on('error',function(e){
    		me.fireError(e);
    	});
    	
    	this.client.on('end',function(){
    		me.onDisconnect();
    	});
    	
    	// Authenticate/authorize if a password is provided. 
    	if ( this.password !== null ) {
    		this.onAuthorization();
    		this.client.auth(this.password,function(){
    			me.onAuthorized();
    			me.securedConnection = true;
    			if (me.database !== 1)
	    			me.changeDatabase(me.database);
	    		me.testConnection();
            });
       	} else if (this.database !== 1) {
    		this.changeDatabase(this.database);
			this.testConnection();
		} else
			this.testConnection();
		
    },
    
<span id='NGN-datasource-Redis-method-testConnection'>    /**
</span>     * @method
     * Make sure the connection is active. This fires the #connected event on success.
     * @private
     */
    testConnection: function(){
    	var me = this;
    	//TODO: Set a timeout and monitor it.
    	this.client.get('__ngn_test_connect__',function(e,v){
			if (!e) {
				me.onConnected();
				me.onReady();
			}
		});
    },
	
<span id='NGN-datasource-Redis-method-changeDatabase'>	/**
</span>	 * @method
	 * Change which database in the Redis instance the connection should use.
	 * @param {Number} index
	 * The index of the database to connect to. The default Redis configuration
	 * supports 16 databases, meaning any integer from 1-16 would be acceptable.
	 * Acceptable values are dependent on the Redis server configuration.
	 */
	changeDatabase: function(index){
		this.database = index;
		this.client.select(index);
	},
	
<span id='NGN-datasource-Redis-event-ready'>	/**
</span>	 * @event ready
	 * Fired when the connection is ready for interaction with a client.
	 */
	onReady: function(){
		this.emit('ready');
	}
    
});

// Create a module out of this.
module.exports = Class;
</pre>
</body>
</html>
