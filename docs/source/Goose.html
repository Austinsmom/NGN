<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var Base        = require('../../../core/ORM'),
	mongoose	= require('mongoose'),
	Schema		= mongoose.Schema;
<span id='NGNX-datasource-orm-Goose'>/**
</span> * @class NGNX.datasource.orm.Goose
 * Goose provides MongoDB Object Relational Mapping, based on the popular [mongoose](http://mongoosejs.com) module.
 * In addition to all of the features and functionality of Mongoose, Goose provides several
 * additional features. Goose was designed to simplify the management of Mongoose schemas, 
 * boilerplate code, and common plugins.
 * @extends NGN.core.ORM
 * @author Corey Butler
 */
var Class = Base.extend({
	
	constructor: function(config){
		
		var me = this;
		
		Class.super.constructor.call(this,config);
		
		Object.defineProperties(this,{
			
<span id='NGNX-datasource-orm-Goose-cfg-schemas'>			/**
</span>			 * @cfg {String} [schemas=null]
			 * Directory path where schema modules exist.
			 */
			modelpath: {
				value:		config.schemas || null,
				enumerable:	false,
				writable:	true
			},
			
<span id='NGNX-datasource-orm-Goose-property-_schema'>			/**
</span>			 * @property {Object}
			 * The raw key/value object containing all available schemas.
			 * @private
			 */
			_schema: {
				value:		{},
				enumerable:	false,
				writable:	true
			},
			
<span id='NGNX-datasource-orm-Goose-property-schemas'>			/**
</span>			 * @property {Object}
			 * A key/value object containing all of he available schemas.
			 * 
			 */
			schemas: {
				enumerable:	true,
				get:		function(){ return this._schema; }
			},
			
<span id='NGNX-datasource-orm-Goose-cfg-globalPlugins'>			/**
</span>			 * @cfg {Object/Array}
			 * An object or array of plugins applied to every schema.
			 * All objects should be [mongoose](http://mongoosejs.com) plugins.
			 */
			globalPlugins: {
				value:		config.globalPlugins || [],
				enumerable:	false,
				writable:	true
			},
			
<span id='NGNX-datasource-orm-Goose-cfg-maxRetries'>			/**
</span>			 * @cfg {Number} [maxRetries=100]
			 * The maximum number of retires before schema loading fails.
			 */
			maxRetries: {
				value:		config.maxRetries || 100,
				enuemrable:	true,
				writable:	true
			},
			
<span id='NGNX-datasource-orm-Goose-property-driver'>			/**
</span>			 * @property
			 * A shortcut providing direct access to the native MongoDB driver.
			 * This can be used to perform queries directly against the MongoDB.
			 */
			driver: {
				value:		null,
				enumerable:	true,
				writable:	true
			}
			
		});
		
		if (typeof config.connection == 'string')
			config.connection = __NGN.app.getDatasource(config.connection);
		
		this.connection = mongoose.connection = config.connection;
		
		this.mongo = config.connection.getClient();
		
		if (!Array.isArray(this.globalPlugins))
			this.globalPlugins = [this.globalPlugins];
		
		this.on('initialized',function(){
			me.onReady();
		});
		
		this.initializeSchemas();
		
	},
	
<span id='NGNX-datasource-orm-Goose-method-initializeSchemas'>	/**
</span>	 * @method
	 * Initialize the schemas.
	 * @param {Object} path
	 * Defaults to #schemas
	 */
	initializeSchemas: function(path) {
		path = path || this.schemas;
		
		if (!this.connection.connected)
			this.fireError('Goose schemas cannot be initialized because the data source is not connected.');

		var me			= this,
			incomplete	= new Array,
			retry		= new Array,
			max			= this.maxRetries,
			tryCt		= 0
			SchemaModel	= {};

		
		if (path) {
			require('wrench').readdirSyncRecursive(this.modelpath).forEach(function( file ){
				
				//Convert filename to array
				var name = __NGN.path.basename(file);
			
				//Export the schema object
				if (__NGN.path.extname.toLowerCase() === 'js') {
					SchemaModel[name] = require( __NGN.path.join(me.modelpath,file));
					incomplete.push(name)
				}
			});
			
			//Loop through the schemas and implement them.
			while ( incomplete.length &gt; 0  &amp;&amp;  tryCt &lt;= max  ||  retry.length &gt; 0 ) {
			
				if ( incomplete.length == 0 ) {
					incomplete 	= retry;
					retry		= [];
				}
			
				tryCt++;
				try {
					
					//Register the data model
					mongoose.model( incomplete[0], SchemaModel[incomplete[0]] );
					
					//Get the registered schema for application use
					this._schema[incomplete[0]] = mongoose.model( incomplete[0] );
				
					// Apply global plugins
					for(var i=0;i&lt;this.globalPlugins.length;i++){
						this._schema[incomplete[0]].plugin(this.globalPlugins[i]);
					}
					
					//Remove the model once it's complete
					incomplete.shift();
					
				} catch (e) {
					retry.push( incomplete[0] );
					incomplete.shift();
				}
			
			}
			
			delete SchemaModel;
			
			if (tryCt &gt; max)
				this.fireError('Goose schemas failed to load (too many retries).');

			this.onInitialized();
		}
	},
	
<span id='NGNX-datasource-orm-Goose-event-initialized'>	/**
</span>	 * @event initialized
	 * Fired when the schemas are initialized.
	 */	
	onInitialized: function(){
		this.emit('initialized');
	}
});

module.exports = Class;</pre>
</body>
</html>
